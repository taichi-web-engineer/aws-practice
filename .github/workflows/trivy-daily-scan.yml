name: Weekly Trivy Scan

on:
  schedule:
    # JST: 日曜 00:00 (= UTC: 土曜 15:00)
    - cron: '0 15 * * 6'

  workflow_dispatch: # 手動実行を可能にする

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    steps:
      # 1) リポジトリを取得
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Buildx でイメージをビルド（push しない）
      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          load: true # ローカルにロード
          tags: myapp:scan

      # 3) Trivy で脆弱性スキャン
      - name: Trivy scan (all severities, fail on ANY)
        uses: aquasecurity/trivy-action@0.22.0
        with:
          image-ref: myapp:scan
          severity: UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL   # 5 段階すべて
          exit-code: 1                                 # １件でも見つかればジョブ失敗
          ignore-unfixed: true                         # パッケージ更新で解決しない脆弱性を無視